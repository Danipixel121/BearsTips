---
import { supabase } from '../../lib/supabase.ts';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const { data: tutorialesData } = await supabase
  .from('tutoriales')
  .select(`
    *,
    traducciones:tutoriales_traducciones(*)
  `);

const tutoriales = (tutorialesData || []).map(t => ({
  ...t,
  titulo: t.traducciones.find(tr => tr.idioma === 'en')?.titulo || '',
  logo: t.logo_url
}));

const categorias = [...new Set(tutoriales.map(t => t.categoria))];

const tree = categorias.map(categoria => ({
  categoria,
  tutoriales: tutoriales.filter(t => t.categoria === categoria)
}));
---

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home - BearsTips</title>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <Header />

  <main>

    <section class="buscador">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Search tutorial..."
      />
    </section>

    <section class="categorias-grid">
      <h2 class="titulo-seccion">All tutorials</h2>
      {tree.map((c, i) => (
        <div class="categoria-bloque" id={`categoria-${i}`}>
          <h2 class="categoria-titulo">{c.categoria}</h2>
          <ul class="tutoriales-cards">
            {c.tutoriales.map(t => (
              <li data-titulo={t.titulo.toLowerCase()}>
                <a href={`/en/categoria/${c.categoria.toLowerCase()}`} class="tutorial-card">
                  <div class="card-img-wrap">
                    <img src={t.logo} alt={t.titulo} loading="lazy" />
                  </div>
                  <span class="card-titulo">{t.titulo}</span>
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </section>

  </main>

  <Footer />

<script>
  function normalizar(texto: string): string {
    return texto
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  const input = document.getElementById("searchInput") as HTMLInputElement | null;

  input?.addEventListener("input", () => {
    const valor = normalizar(input.value);

    document.querySelectorAll(".categoria-bloque").forEach(bloque => {
      let visibles = 0;

      bloque.querySelectorAll<HTMLElement>("li[data-titulo]").forEach(item => {
        const titulo = normalizar(item.getAttribute("data-titulo") || "");
        const mostrar = valor === "" || titulo.includes(valor);
        item.style.display = mostrar ? "block" : "none";
        if (mostrar) visibles++;
      });

      (bloque as HTMLElement).style.display = visibles > 0 ? "block" : "none";
    });
  });
</script>

</body>
</html>

<style>
  body {
    margin: 0;
  }

.buscador {
  display: flex;
  justify-content: flex-start;
  max-width: 900px;
  margin: 4rem auto 0;
  padding: 0 4rem;
}

  .buscador input {
    width: 100%;
    max-width: 400px;
    padding: 10px 16px;
    font-size: 16px;
    border: 2px solid #ddd;
    border-radius: 15px;
    outline: none;
    transition: border-color 0.2s;
    font-family: 'Bebas Neue';
  }

  .buscador input:focus {
    border-color: #00ff9d;
  }

  .categorias-grid {
    display: flex;
    flex-direction: column;
    gap: 3rem;
    padding: 3rem 4rem;
    align-items: center;
    max-width: 900px;
    margin: 0 auto;
  }

  .titulo-seccion {
    font-size: 3.5rem;
    font-family: 'Bebas Neue';
    width: 100%;
  }

  .categoria-bloque {
    scroll-margin-top: 80px;
    width: 100%;
  }

  .categoria-titulo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    border-left: 5px solid #00ff9d;
    padding-left: 0.75rem;
    margin-bottom: 1.25rem;
  }

  .tutoriales-cards {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
  }

  .tutoriales-cards li {
    display: block;
  }

  .tutorial-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-decoration: none;
    background: #f7f7f7;
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 1rem 0.75rem 0.85rem;
    gap: 0.6rem;
    aspect-ratio: 1 / 1;
    transition: border-color 0.2s, background 0.2s, transform 0.15s, box-shadow 0.2s;
    overflow: hidden;
    cursor: pointer;
  }

  .tutorial-card:hover {
    border-color: #00ff9d;
    background: #fff;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 255, 157, 0.15);
  }

  .card-img-wrap {
    width: 60%;
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .card-img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .card-titulo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    color: #222;
    text-align: center;
    line-height: 1.2;
    word-break: break-word;
    hyphens: auto;
  }

  .tutorial-card:hover .card-titulo {
    color: #000;
  }

@media (max-width: 640px) {
  .buscador {
    margin: 2.5rem auto 0;
    padding: 0 1.25rem;
    justify-content: center;
  }

  .buscador input {
    max-width: 100%;
    width: 100%;
    font-size: 20px;
    padding: 14px 20px;
    text-align: center;
    border-radius: 20px;
  }

  .categorias-grid {
    padding: 2rem 1.25rem;
    gap: 3rem;
    align-items: center;
    text-align: center;
  }

  .titulo-seccion {
    font-size: 3.8rem;
    text-align: center;
    width: 100%;
  }

  .categoria-bloque {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  .categoria-titulo {
    font-size: 2.6rem;
    border-left: none;
    border-top: 5px solid #00ff9d;
    padding-left: 0;
    padding-top: 0.7rem;
    margin-bottom: 1.25rem;
    text-align: center;
    width: 100%;
  }

  .tutoriales-cards {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.1rem;
    width: 100%;
    justify-items: center;
  }

  .tutoriales-cards li {
    width: 100%;
  }

  .tutorial-card {
    padding: 1.5rem 1rem 1.25rem;
    border-radius: 18px;
    gap: 0.8rem;
    aspect-ratio: 1 / 1;
    align-items: center;
    justify-content: center;
  }

  .card-img-wrap {
    width: 65%;
  }

  .card-titulo {
    font-size: 1.15rem;
    text-align: center;
  }
}

@media (max-width: 380px) {
  .titulo-seccion {
    font-size: 3rem;
  }

  .categoria-titulo {
    font-size: 2.1rem;
  }

  .tutoriales-cards {
    gap: 0.9rem;
  }

  .tutorial-card {
    padding: 1.2rem 0.8rem 1rem;
  }

  .card-titulo {
    font-size: 1rem;
  }
}
</style>