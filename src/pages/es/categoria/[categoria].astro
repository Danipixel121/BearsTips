---
import { supabase } from '../../../lib/supabase.ts';
import Header from '../../../components/Header.astro';

export async function getStaticPaths() {
  const { data: tutorialesData } = await supabase
    .from('tutoriales')
    .select(`
      *,
      traducciones:tutoriales_traducciones(*)
    `);

  const tutoriales = (tutorialesData || []).map(t => ({
    ...t,
    titulo: t.traducciones.find(tr => tr.idioma === 'es')?.titulo || '',
    logo: t.logo_url
  }));

  const categorias = [...new Set(tutoriales.map(t => t.categoria))];

  return categorias.map(categoria => ({
    params: { categoria: categoria.toLowerCase() },
    props: {
      tutorialesFiltrados: tutoriales.filter(t => t.categoria === categoria)
    }
  }));
}

const { categoria } = Astro.params;
const { tutorialesFiltrados } = Astro.props;
---

<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{categoria.toUpperCase()} - BearsTips</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
</head>
<body>
  <Header />

  <main>

    <section class="buscador">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Buscar tutorial..."
      />
    </section>

    <section class="categorias-grid">
      <h2 class="titulo-seccion">{categoria.toUpperCase()}</h2>

      <div class="categoria-bloque">
        <ul class="tutoriales-cards">
          {tutorialesFiltrados.map(t => (
            <li data-titulo={t.titulo.toLowerCase()}>
              <a href={`/es/tutorial/${t.categoria.toLowerCase()}/${t.slug}`} class="tutorial-card">
                <div class="card-img-wrap">
                  <img src={t.logo} alt={t.titulo} loading="lazy" />
                </div>
                <span class="card-titulo">{t.titulo}</span>
              </a>
            </li>
          ))}
        </ul>
      </div>
    </section>

  </main>

  <script>
    function normalizar(texto: string): string {
      return texto
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    const input = document.getElementById("searchInput") as HTMLInputElement | null;

    input?.addEventListener("input", () => {
      const valor = normalizar(input.value);

      document.querySelectorAll<HTMLElement>("li[data-titulo]").forEach(item => {
        const titulo = normalizar(item.getAttribute("data-titulo") || "");
        const mostrar = valor === "" || titulo.includes(valor);
        item.style.display = mostrar ? "block" : "none";
      });
    });
  </script>

</body>
</html>

<style>
  body { margin: 0; }

  .buscador {
    display: flex;
    justify-content: flex-start;
    max-width: 900px;
    margin: 4rem auto 0;
    padding: 0 4rem;
  }

  .buscador input {
    width: 100%;
    max-width: 400px;
    padding: 10px 16px;
    font-size: 16px;
    border: 2px solid #ddd;
    border-radius: 15px;
    outline: none;
    transition: border-color 0.2s;
    font-family: 'Bebas Neue';
  }

  .buscador input:focus { border-color: #00ff9d; }

  .categorias-grid {
    display: flex;
    flex-direction: column;
    gap: 3rem;
    padding: 3rem 4rem;
    align-items: center;
    max-width: 900px;
    margin: 0 auto;
  }

  .titulo-seccion {
    font-size: 3.5rem;
    font-family: 'Bebas Neue';
    width: 100%;
  }

  .categoria-bloque { width: 100%; }

  .tutoriales-cards {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
  }

  .tutoriales-cards li { display: block; }

  .tutorial-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-decoration: none;
    background: #f7f7f7;
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 1rem 0.75rem 0.85rem;
    gap: 0.6rem;
    aspect-ratio: 1 / 1;
    transition: border-color 0.2s, background 0.2s, transform 0.15s, box-shadow 0.2s;
    overflow: hidden;
    cursor: pointer;
  }

  .tutorial-card:hover {
    border-color: #00ff9d;
    background: #fff;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 255, 157, 0.15);
  }

  .card-img-wrap {
    width: 60%;
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .card-img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .card-titulo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    color: #222;
    text-align: center;
    line-height: 1.2;
    word-break: break-word;
    hyphens: auto;
  }

  .tutorial-card:hover .card-titulo { color: #000; }
</style>